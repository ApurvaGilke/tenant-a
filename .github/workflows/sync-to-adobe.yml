name: Sync to Adobe Git

on:
  push:
    branches:
      - main
      - develop
      - 'release/*'
  workflow_dispatch: {}

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this GitHub repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # important to get all history

      - name: Install Git
        run: sudo apt-get update && sudo apt-get install -y git

      - name: Configure Git
        run: |
          git config --global user.name "ci-sync-bot"
          git config --global user.email "ci-sync-bot@example.com"

      - name: Add Adobe remote
        env:
          GIT_USERNAME: ${{ secrets.CM_GIT_USER }}
          GIT_PASSWORD: ${{ secrets.CM_GIT_PASS }}
          ADOBE_REPO_URL: ${{ secrets.CM_REPO_URL }}
        run: |
          # Build URL with embedded credentials
          REPO_URL="https://${GIT_USERNAME}:${GIT_PASSWORD}@${ADOBE_REPO_URL#https://}"
          git remote add adobe "$REPO_URL"
          git fetch --all --prune

      - name: Push mirror to Adobe
        run: |
          git push --mirror adobe