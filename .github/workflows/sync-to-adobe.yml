name: Sync to Adobe Cloud Manager Git

on:
  push:
    branches:
      - main
      - develop
      - 'release/*'
  workflow_dispatch: {}  # allow manual trigger from Actions tab

jobs:
  sync-to-adobe:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # get full history & all branches

      - name: Configure Git user
        run: |
          git config --global user.name "github-sync-bot"
          git config --global user.email "github-sync-bot@example.com"

      - name: Configure Git credentials
        env:
          GIT_USERNAME: ${{ secrets.CM_GIT_USER }}
          GIT_PASSWORD: ${{ secrets.CM_GIT_PASS }}
        run: |
          echo "Configuring Git credentials..."
          git config --global credential.helper store
          echo "https://${GIT_USERNAME}:${GIT_PASSWORD}@git.cloud-manager.adobe.com" > ~/.git-credentials
          chmod 600 ~/.git-credentials
          echo "Git credentials configured"

      - name: Add Adobe remote and fetch
        env:
          ADOBE_REPO_URL: ${{ secrets.CM_REPO_URL }}
        run: |
          echo "========== Git Remotes Before =========="
          git remote -v
          
          echo "========== ADOBE_REPO_URL Value =========="
          echo "URL: $ADOBE_REPO_URL"
          
          echo "========== Testing URL Accessibility =========="
          if curl -I "$ADOBE_REPO_URL" 2>&1 | head -1; then
            echo "URL is accessible"
          else
            echo "Warning: Could not verify URL accessibility with curl"
          fi

          echo "========== Adding Adobe Remote =========="
          # Add Adobe remote if not present
          if ! git remote | grep -q '^adobe$'; then
            git remote add adobe "$ADOBE_REPO_URL"
            echo "Adobe remote added"
          else
            echo "Adobe remote already exists"
          fi

          echo "========== Git Remotes After =========="
          git remote -v

          echo "========== Fetching from GitHub Origin =========="
          git fetch origin --prune
          echo "GitHub fetch completed"

      - name: Push all branches and tags to Adobe
        env:
          ADOBE_REPO_URL: ${{ secrets.CM_REPO_URL }}
        run: |
          echo "========== Setting Adobe Remote URL =========="
          git remote set-url adobe "$ADOBE_REPO_URL"
          echo "Adobe remote URL set to: $ADOBE_REPO_URL"

          echo "========== Final Remote Configuration =========="
          git remote -v

          echo "========== Pushing All Branches =========="
          git push adobe --all

          echo "========== Pushing All Tags =========="
          git push adobe --tags