name: Sync to Adobe Cloud Manager Git

on:
  push:
    branches:
      - main
      - develop
      - 'release/*'
  workflow_dispatch: {}  # allow manual trigger from Actions tab

jobs:
  sync-to-adobe:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout GitHub repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # get full history & all branches

      - name: Configure Git user
        run: |
          git config --global user.name "github-sync-bot"
          git config --global user.email "github-sync-bot@example.com"

      - name: Add Adobe remote and fetch
        env:
          GIT_USERNAME: ${{ secrets.CM_GIT_USER }}
          GIT_PASSWORD: ${{ secrets.CM_GIT_PASS }}
          ADOBE_REPO_URL: ${{ secrets.CM_REPO_URL }}
        run: |
          echo "========== Preparing Adobe Remote URL with Credentials =========="
          # Extract host from ADOBE_REPO_URL and build authenticated URL
          REPO_HOST=$(echo "$ADOBE_REPO_URL" | sed 's|https://||' | sed 's|/.*||')
          REPO_PATH=$(echo "$ADOBE_REPO_URL" | sed "s|https://${REPO_HOST}||")
          ADOBE_REPO_URL_WITH_CREDS="https://${GIT_USERNAME}:${GIT_PASSWORD}@${REPO_HOST}${REPO_PATH}"
          
          echo "========== Git Remotes Before =========="
          git remote -v
          
          echo "========== Adding Adobe Remote =========="
          # Add Adobe remote if not present
          if ! git remote | grep -q '^adobe$'; then
            git remote add adobe "$ADOBE_REPO_URL_WITH_CREDS"
            echo "Adobe remote added with credentials"
          else
            git remote set-url adobe "$ADOBE_REPO_URL_WITH_CREDS"
            echo "Adobe remote updated with credentials"
          fi

          echo "========== Git Remotes After =========="
          git remote -v

          echo "========== Fetching from GitHub Origin =========="
          git fetch origin --prune
          echo "GitHub fetch completed"

      - name: Push all branches and tags to Adobe
        run: |
          echo "========== Final Remote Configuration =========="
          git remote -v

          echo "========== Pushing All Branches =========="
          git push adobe --all

          echo "========== Pushing All Tags =========="
          git push adobe --tags